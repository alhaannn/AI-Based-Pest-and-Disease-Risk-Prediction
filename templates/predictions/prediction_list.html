{% extends 'base.html' %}
{% load static %}

{% block title %}AI Predictions - Pest & Disease Risk Prediction{% endblock %}

{% block content %}
<div class="predictions-page">
    <div class="flex-between mb-3">
        <h1><i class="fas fa-brain"></i> AI Risk Predictions</h1>
        <div class="flex gap-2">
            <a href="{% url 'predictions:export_predictions_csv' %}{% if risk_level or selected_crop or selected_pest %}?{% if risk_level %}risk_level={{ risk_level }}&{% endif %}{% if selected_crop %}crop={{ selected_crop }}&{% endif %}{% if selected_pest %}pest={{ selected_pest }}{% endif %}{% endif %}" class="btn btn-outline">
                <i class="fas fa-file-csv"></i> Export CSV
            </a>
            <a href="{% url 'predictions:export_all_data' %}" class="btn btn-outline">
                <i class="fas fa-download"></i> Export All Data
            </a>
            <a href="{% url 'predictions:prediction_analytics' %}" class="btn btn-secondary">
                <i class="fas fa-chart-bar"></i> Analytics
            </a>
            <a href="{% url 'predictions:generate_predictions' %}" class="btn btn-primary">
                <i class="fas fa-magic"></i> Generate Predictions
            </a>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="grid grid-4 mb-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-list"></i></div>
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Predictions</div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-value">{{ stats.high_risk }}</div>
            <div class="stat-label">High Risk</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="stat-value">{{ stats.medium_risk }}</div>
            <div class="stat-label">Medium Risk</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-value">{{ stats.low_risk }}</div>
            <div class="stat-label">Low Risk</div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="flex gap-2">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <select name="crop" class="form-control">
                        <option value="">All Crops</option>
                        {% for crop in crops %}
                            <option value="{{ crop.pk }}" {% if selected_crop == crop.pk|stringformat:"s" %}selected{% endif %}>
                                {{ crop.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <select name="pest" class="form-control">
                        <option value="">All Pests</option>
                        {% for pest in pests %}
                            <option value="{{ pest.pk }}" {% if selected_pest == pest.pk|stringformat:"s" %}selected{% endif %}>
                                {{ pest.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 0 0 200px; margin-bottom: 0;">
                    <select name="risk_level" class="form-control">
                        <option value="">All Risk Levels</option>
                        <option value="HIGH" {% if risk_level == 'HIGH' %}selected{% endif %}>High Risk</option>
                        <option value="MEDIUM" {% if risk_level == 'MEDIUM' %}selected{% endif %}>Medium Risk</option>
                        <option value="LOW" {% if risk_level == 'LOW' %}selected{% endif %}>Low Risk</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filter</button>
                {% if risk_level or selected_crop or selected_pest %}
                    <a href="{% url 'predictions:prediction_list' %}" class="btn btn-outline">
                        <i class="fas fa-times"></i> Clear
                    </a>
                {% endif %}
            </form>
        </div>
    </div>
    
    <!-- Predictions Table -->
    <div class="card">
        <div class="card-header flex-between">
            <span><i class="fas fa-table"></i> Prediction Results</span>
            <span style="color: var(--text-muted); font-size: 0.9rem;">Showing latest 50 predictions</span>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Crop</th>
                        <th>Pest/Disease</th>
                        <th>Risk Score</th>
                        <th>Risk Level</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prediction in predictions %}
                        <tr>
                            <td>{{ prediction.prediction_date }}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-seedling" style="color: var(--success-color);"></i>
                                    {{ prediction.crop.name }}
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-bug" style="color: var(--danger-color);"></i>
                                    {{ prediction.pest.name }}
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="background: var(--bg-primary); border-radius: 4px; height: 8px; width: 60px; overflow: hidden;">
                                        <div style="background: {% if prediction.risk_level == 'HIGH' %}var(--danger-color){% elif prediction.risk_level == 'MEDIUM' %}var(--warning-color){% else %}var(--success-color){% endif %}; height: 100%; width: {{ prediction.risk_score }}%;"></div>
                                    </div>
                                    <strong>{{ prediction.risk_score }}%</strong>
                                </div>
                            </td>
                            <td>
                                <span class="badge-pill badge-{% if prediction.risk_level == 'HIGH' %}danger{% elif prediction.risk_level == 'MEDIUM' %}warning{% else %}success{% endif %}">
                                    {{ prediction.get_risk_level_display }}
                                </span>
                            </td>
                            <td>{{ prediction.confidence }}%</td>
                            <td>
                                <a href="{% url 'predictions:prediction_detail' prediction.pk %}" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                    <i class="fas fa-eye"></i> Details
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                <i class="fas fa-brain" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>No predictions generated yet.</p>
                                <a href="{% url 'predictions:generate_predictions' %}" class="btn btn-primary mt-2">
                                    <i class="fas fa-magic"></i> Generate Predictions
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
