{% extends 'base.html' %}
{% load static %}

{% block title %}Weather Analysis - Pest & Disease Risk Prediction{% endblock %}

{% block content %}
<div class="weather-analysis-page">
    <h1><i class="fas fa-chart-line"></i> Detailed Weather Analysis</h1>
    
    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="flex gap-2">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label class="form-label">Location</label>
                    <select name="location" class="form-control">
                        <option value="">All Locations</option>
                        {% for loc in locations %}
                            <option value="{{ loc }}" {% if selected_location == loc %}selected{% endif %}>{{ loc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 0 0 200px; margin-bottom: 0;">
                    <label class="form-label">Time Period</label>
                    <select name="days" class="form-control">
                        <option value="7" {% if selected_days == 7 %}selected{% endif %}>Last 7 Days</option>
                        <option value="14" {% if selected_days == 14 %}selected{% endif %}>Last 14 Days</option>
                        <option value="30" {% if selected_days == 30 %}selected{% endif %}>Last 30 Days</option>
                        <option value="60" {% if selected_days == 60 %}selected{% endif %}>Last 60 Days</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="align-self: flex-end;">
                    <i class="fas fa-sync"></i> Update Analysis
                </button>
            </form>
        </div>
    </div>
    
    {% if analysis.has_data %}
        <!-- Comprehensive Stats -->
        <div class="grid grid-4 mb-3">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-temperature-high"></i></div>
                <div class="stat-value">{{ analysis.avg_temperature }}°C</div>
                <div class="stat-label">Average Temperature</div>
            </div>
            
            <div class="stat-card info">
                <div class="stat-icon"><i class="fas fa-tint"></i></div>
                <div class="stat-value">{{ analysis.avg_humidity }}%</div>
                <div class="stat-label">Average Humidity</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon"><i class="fas fa-cloud-rain"></i></div>
                <div class="stat-value">{{ analysis.total_rainfall }}mm</div>
                <div class="stat-label">Total Rainfall</div>
            </div>
            
            <div class="stat-card {{ analysis.risk_color }}">
                <div class="stat-icon"><i class="fas fa-wind"></i></div>
                <div class="stat-value">{{ analysis.avg_wind_speed }}</div>
                <div class="stat-label">Avg Wind Speed (km/h)</div>
            </div>
        </div>
        
        <!-- Detailed Risk Assessment -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-shield-alt"></i> Comprehensive Risk Assessment
            </div>
            <div class="card-body">
                <div class="grid grid-2">
                    <div>
                        <h3 style="margin-bottom: 1rem;">
                            Overall Risk: 
                            <span class="badge-pill badge-{{ analysis.risk_color }}" style="font-size: 1.3rem; padding: 0.5rem 1rem;">
                                {{ analysis.risk_level }}
                            </span>
                        </h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Risk Percentage</h4>
                            <div style="background: var(--bg-primary); border-radius: 8px; height: 40px; position: relative; overflow: hidden;">
                                <div style="background: var(--{{ analysis.risk_color }}-color); height: 100%; width: {{ analysis.risk_percentage }}%; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: width 1s ease;">
                                    {{ analysis.risk_percentage }}%
                                </div>
                            </div>
                        </div>
                        
                        <p style="color: var(--text-secondary);">
                            <strong>{{ analysis.high_risk_days }}</strong> out of <strong>{{ analysis.days_analyzed }}</strong> days 
                            showed conditions favorable for pest/disease outbreaks.
                        </p>
                    </div>
                    
                    <div>
                        {% if analysis.risk_factors %}
                            <h4 style="margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Identified Risk Factors:</h4>
                            <div style="background: var(--bg-primary); border-radius: 8px; padding: 1.5rem; border-left: 4px solid var(--{{ analysis.risk_color }}-color);">
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    {% for factor in analysis.risk_factors %}
                                        <li style="margin-bottom: 0.75rem; color: var(--text-secondary);">{{ factor }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 2rem; text-align: center; border-left: 4px solid var(--success-color);">
                                <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--success-color); margin-bottom: 0.5rem;"></i>
                                <p style="color: var(--text-secondary); margin: 0;">No significant risk factors identified in this period.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Charts -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-area"></i> Environmental Trends Analysis
            </div>
            <div class="card-body">
                <canvas id="detailedWeatherChart" style="height: 400px;"></canvas>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body" style="text-align: center; padding: 4rem;">
                <i class="fas fa-chart-line" style="font-size: 4rem; color: var(--text-muted); opacity: 0.3; margin-bottom: 1.5rem;"></i>
                <h3 style="color: var(--text-muted); margin-bottom: 0.5rem;">No Data Available</h3>
                <p style="color: var(--text-muted);">{{ analysis.message }}</p>
                <a href="{% url 'weather:weather_create' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus"></i> Add Weather Data
                </a>
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const trendData = JSON.parse('{{ trend_data|safe }}');
    
    const ctx = document.getElementById('detailedWeatherChart');
    if (ctx && trendData.dates && trendData.dates.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.dates,
                datasets: [
                    {
                        label: 'Temperature (°C)',
                        data: trendData.temperatures,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        fill: true,
                    },
                    {
                        label: 'Humidity (%)',
                        data: trendData.humidity,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        fill: true,
                    },
                    {
                        label: 'Rainfall (mm)',
                        data: trendData.rainfall,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        fill: true,
                        type: 'bar',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Temperature, Humidity, and Rainfall Trends'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (°C) / Humidity (%)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Rainfall (mm)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                }
            }
        });
    }
});
</script>
{% endblock %}
